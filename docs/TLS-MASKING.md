# TLS –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ MTProxy –¥–ª—è –æ–±—Ö–æ–¥–∞ —Ü–µ–Ω–∑—É—Ä—ã

## üé≠ –ß—Ç–æ —Ç–∞–∫–æ–µ TLS –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞?

TLS –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç MTProxy –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–π HTTPS —Å–∞–π—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, `web.max.ru`), —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ–±—Ö–æ–¥–∏—Ç—å —Ü–µ–Ω–∑—É—Ä—É –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –¶–µ–Ω–∑–æ—Ä—ã —Å–∫–∞–Ω–∏—Ä—É—é—Ç —Å–µ—Ä–≤–µ—Ä—ã –∏ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–µ –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π —Å–∞–π—Ç - –µ–≥–æ –±–ª–æ–∫–∏—Ä—É—é—Ç.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TLS –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–û–±—Ä–∞–∑ MTProxy**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `skrashevich/mtproxy:latest` (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç TLS –º–∞—Å–∫–∏—Ä–æ–≤–∫—É)
2. **TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç**: –ù—É–∂–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –¥–æ–º–µ–Ω–∞, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–π –º–∞—Å–∫–∏—Ä—É–µ–º—Å—è

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `web.max.ru`):

```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–æ–¥—ã
scp cert.pem user@node-server:/path/to/certs/
scp key.pem user@node-server:/path/to/certs/
```

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ Let's Encrypt

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ certbot
sudo apt-get update
sudo apt-get install certbot

# –ü–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –¥–æ–º–µ–Ω–∞
sudo certbot certonly --standalone -d web.max.ru

# –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –±—É–¥—É—Ç –≤:
# /etc/letsencrypt/live/web.max.ru/fullchain.pem
# /etc/letsencrypt/live/web.max.ru/privkey.pem
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í —Ñ–∞–π–ª–µ `.env` –Ω–∞ –Ω–æ–¥–µ –¥–æ–±–∞–≤—å—Ç–µ:

```bash
# TLS –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞
TLS_DOMAIN=web.max.ru
TLS_CERT_PATH=/etc/letsencrypt/live/web.max.ru/fullchain.pem
TLS_KEY_PATH=/etc/letsencrypt/live/web.max.ru/privkey.pem

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ skrashevich/MTProxy –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ TLS
MT_PROXY_IMAGE=skrashevich/mtproxy:latest
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–æ–¥—ã

```bash
cd tg-mtroxy
./scripts/manage-node.sh restart
```

## üìã –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **MTProxy —Å TLS –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–º–µ–Ω–∞
2. –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π HTTPS —Å–∞–π—Ç
3. –¶–µ–Ω–∑–æ—Ä—ã –≤–∏–¥—è—Ç –≤–∞–ª–∏–¥–Ω—ã–π TLS handshake –∏ –Ω–µ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∏—Ç—å –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞
4. MTProxy —Ç—Ä–∞—Ñ–∏–∫ —Å–∫—Ä—ã—Ç –≤–Ω—É—Ç—Ä–∏ TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–î–æ–º–µ–Ω –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä**: DNS –∑–∞–ø–∏—Å—å –¥–ª—è `web.max.ru` –¥–æ–ª–∂–Ω–∞ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
2. **–ü–æ—Ä—Ç 443**: MTProxy –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –ø–æ—Ä—Ç—É 443 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTPS –ø–æ—Ä—Ç)
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤**: Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π
4. **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–∞–π—Ç—ã**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–π –¥–æ–º–µ–Ω –∏–ª–∏ –º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Å–∞–π—Ç

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ Let's Encrypt

–î–æ–±–∞–≤—å—Ç–µ –≤ crontab:

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 60 –¥–Ω–µ–π
0 3 1 */2 * certbot renew --quiet && docker restart mtproxy
```

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ TLS handshake
openssl s_client -connect your-domain.com:443 -servername web.max.ru

# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è web.max.ru
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- [skrashevich/MTProxy](https://github.com/skrashevich/MTProxy) - —Ñ–æ—Ä–∫ MTProxy —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π TLS –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏
- [Let's Encrypt](https://letsencrypt.org/) - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

