version: '3.8'

services:
  # Node Agent API для управления прокси
  node-agent:
    build:
      context: ./node-agent
      dockerfile: Dockerfile
    container_name: mtproxy-node-agent
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - API_TOKEN=${API_TOKEN}
      - API_PORT=8080
      - DOMAIN=${DOMAIN}
      - INTERNAL_IP=${INTERNAL_IP}
      - MTPROTO_PORT=443
      - SOCKS5_PORT=1080
      - WORKERS=${WORKERS:-2}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/app/data
      - ./certs:/app/certs:ro
    ports:
      - "8080:8080"
    networks:
      - mtproxy-network
    depends_on:
      - mtproto
      - socks5

  # MTProto Proxy
  mtproto:
    image: telegrammessenger/proxy:latest
    container_name: mtproxy
    restart: unless-stopped
    environment:
      - SECRET=${SECRET:-}
      - SECRET_COUNT=${SECRET_COUNT:-1}
      - TAG=${TAG:-}
      - WORKERS=${WORKERS:-2}
    volumes:
      - mtproto-config:/data
    ports:
      - "${MTPROTO_PORT:-443}:443"
      - "2398:2398"  # Stats endpoint
    networks:
      - mtproxy-network
    command: >
      sh -c "
      if [ -n '${INTERNAL_IP}' ] && [ -n '${DOMAIN}' ]; then
        echo 'Using NAT info: ${INTERNAL_IP}:${DOMAIN}';
        exec mtproto-proxy --nat-info ${INTERNAL_IP}:${DOMAIN};
      else
        exec mtproto-proxy;
      fi
      "

  # SOCKS5 Proxy (3proxy с авторизацией)
  socks5:
    image: tarampampam/3proxy:latest
    container_name: mtproxy-socks5
    restart: unless-stopped
    volumes:
      - ./socks5/3proxy.cfg:/etc/3proxy/3proxy.cfg:ro
    ports:
      - "${SOCKS5_PORT:-1080}:1080"
    networks:
      - mtproxy-network

volumes:
  mtproxy-config:

networks:
  mtproxy-network:
    driver: bridge
