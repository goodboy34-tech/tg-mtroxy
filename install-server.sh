#!/bin/bash

set -e

echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MTProxy Management System"
echo "========================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
if [ ! -f .env ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:"
    echo ""
    echo "BOT_TOKEN=your_bot_token"
    echo "ADMIN_IDS=your_telegram_id"
    echo "LOCAL_SECRET=your_mtproto_secret"
    echo "LOCAL_WORKERS=2"
    echo "LOCAL_MTPROTO_PORT=8443"
    echo "LOCAL_SOCKS5_PORT=1081"
    exit 1
fi

echo "‚úÖ .env —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
source .env
if [ -z "$BOT_TOKEN" ] || [ -z "$ADMIN_IDS" ]; then
    echo "‚ùå BOT_TOKEN –∏ ADMIN_IDS –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –≤ .env —Ñ–∞–π–ª–µ!"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p data
mkdir -p certs
mkdir -p socks5

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SOCKS5
if [ ! -f socks5/sockd-local.conf ]; then
    echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SOCKS5..."
    cat > socks5/sockd-local.conf << 'EOF'
logoutput: stderr

internal: 0.0.0.0 port = 1080
external: eth0

clientmethod: none
socksmethod: none

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: error
}

socks pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: error
}
EOF
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SOCKS5 —Å–æ–∑–¥–∞–Ω–∞"
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üõë –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down -v 2>/dev/null || true
docker rm -f mtproxy-control mtproxy-local mtproxy-local-socks5 2>/dev/null || true

# –û—á–∏—Å—Ç–∫–∞ Docker –∫—ç—à–∞
echo "üßπ –û—á–∏—Å—Ç–∫–∞ Docker –∫—ç—à–∞..."
docker system prune -f

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
echo "üî® –°–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (—ç—Ç–æ –∑–∞–π–º—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)..."
docker compose build --no-cache

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose up -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker compose ps

echo ""
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞:"
docker compose logs control-panel --tail=30

echo ""
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π:"
echo "  ./scripts/manage.sh start      - –∑–∞–ø—É—Å—Ç–∏—Ç—å"
echo "  ./scripts/manage.sh stop       - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
echo "  ./scripts/manage.sh restart    - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å"
echo "  ./scripts/manage.sh logs       - –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
echo "  ./scripts/manage.sh status     - —Å—Ç–∞—Ç—É—Å –∏ —Ä–µ—Å—É—Ä—Å—ã"
echo "  ./scripts/manage.sh update     - –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑ GitHub"
echo ""
echo "üì± –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É /start –≤ Telegram"
echo ""
