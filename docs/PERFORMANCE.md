# Рекомендации по оптимизации производительности

## MTProto Docker контейнер

### Рекомендуемые параметры `MT_DOCKER_RUN_ARGS`

Для предотвращения утечек памяти и оптимизации производительности при высокой нагрузке:

```bash
MT_DOCKER_RUN_ARGS="--memory=512m --memory-swap=512m --cpus=1.0 --ulimit nofile=65536:65536 --log-opt max-size=10m --log-opt max-file=3"
```

### Объяснение параметров

- `--memory=512m`: Ограничение RAM для контейнера (настройте под ваши нужды)
- `--memory-swap=512m`: Отключение swap (предотвращает swap thrashing)
- `--cpus=1.0`: Ограничение CPU (настройте под ваши нужды)
- `--ulimit nofile=65536:65536`: Увеличение лимита открытых файлов для большого количества соединений
- `--log-opt max-size=10m --log-opt max-file=3`: Ограничение размера логов

### Альтернативные MTProto реализации

Текущая система использует официальный `telegrammessenger/proxy:latest`, который не обновлялся 8 лет.

**Рекомендуемые современные форки:**

1. **Telemt** (Rust) — высокая производительность, асинхронность
   ```bash
   MT_PROXY_IMAGE=telemt/proxy:latest
   ```

2. **mtg** (Go) — быстрый и стабильный
   ```bash
   MT_PROXY_IMAGE=mtg/mtg:latest
   ```

3. **mtproto-proxy** (Python) — проверенный временем форк
   ```bash
   MT_PROXY_IMAGE=seriyps/mtproto-proxy:latest
   ```

**Важно:** Перед переходом на новый форк протестируйте на тестовой ноде!

## SOCKS5 оптимизация

Если SOCKS5 не используется, отключите его:

```bash
ENABLE_SOCKS5=false
```

Это сэкономит ресурсы и упростит управление.

## База данных

### SQLite оптимизация

Текущая конфигурация использует WAL mode для лучшей производительности:

```sql
PRAGMA journal_mode = WAL;
PRAGMA foreign_keys = ON;
```

### При высокой нагрузке (>2000 пользователей)

Рассмотрите переход на PostgreSQL:

1. Создайте PostgreSQL контейнер в `docker-compose.yml`
2. Обновите `database.ts` для использования `pg` вместо `better-sqlite3`
3. Миграция данных из SQLite в PostgreSQL

## Redis кэширование

Redis уже добавлен в `docker-compose.yml` для кэширования:

- Кэширование результатов проверки подписок
- Сессии пользователей
- Счетчики трафика

**Использование Redis (опционально):**

```typescript
import Redis from 'ioredis';
const redis = new Redis(process.env.REDIS_HOST, process.env.REDIS_PORT);
```

## Мониторинг ресурсов

### Проверка использования ресурсов

```bash
# На ноде
docker stats mtproxy

# Статистика через бота
/stats
```

### Алерты при высокой нагрузке

Настройте мониторинг через cron или внешние системы (Prometheus, Grafana):

```bash
# Пример скрипта проверки
if [ $(docker stats --no-stream --format "{{.MemUsage}}" mtproxy | awk '{print $1}' | sed 's/[^0-9.]//g') -gt 500 ]; then
  echo "High memory usage detected"
fi
```

## Масштабирование

### Горизонтальное масштабирование

1. Добавьте больше нод через `/add_node` в боте
2. Распределите пользователей по нодам через подписки
3. Используйте балансировщик нагрузки для доменов

### Вертикальное масштабирование

1. Увеличьте `WORKERS` для MTProto (но не более количества CPU ядер)
2. Увеличьте лимиты памяти в `MT_DOCKER_RUN_ARGS`
3. Используйте более мощные серверы для нод

## Рекомендации для продакшена

1. **Минимум 2GB RAM** на ноду для стабильной работы
2. **SSD диски** для базы данных (особенно при использовании SQLite)
3. **Регулярные бэкапы** базы данных (`./data/proxy.db`)
4. **Мониторинг логов** через внешние системы
5. **Автоматические рестарты** при сбоях (уже настроено через `restart: unless-stopped`)

## Troubleshooting

### Высокое использование памяти

1. Проверьте количество активных соединений: `/stats`
2. Уменьшите `WORKERS` если CPU не используется полностью
3. Рассмотрите переход на более современный MTProto форк

### Медленная работа

1. Проверьте сетевую задержку между control-panel и нодами
2. Убедитесь, что база данных не фрагментирована (SQLite)
3. Проверьте использование CPU через `/health`

### Утечки памяти

1. Используйте рекомендуемые `MT_DOCKER_RUN_ARGS` с ограничением памяти
2. Регулярно перезапускайте контейнеры (можно через cron)
3. Мониторьте использование памяти через `docker stats`

