services:
  # Caddy для автоматического HTTPS
  caddy:
    image: caddy:2-alpine
    container_name: mtproxy-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - ./data/logs:/var/log/caddy
    networks:
      - mtproxy-network
    environment:
      - ACME_AGREE=${ACME_AGREE:-true}
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

  control-panel:
    build:
      context: ./control-panel
      dockerfile: Dockerfile
    container_name: mtproxy-control
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - BOT_TOKEN=${BOT_TOKEN}
      - ADMIN_IDS=${ADMIN_IDS}
      - REMNAWAVE_API_KEY=${REMNAWAVE_API_KEY}
      - REMNAWAVE_API_PORT=${REMNAWAVE_API_PORT:-8081}
      - WEB_API_KEY=${WEB_API_KEY}
      - WEB_API_PORT=${WEB_API_PORT:-8082}
      # Backend (api-1.yaml) — источник правды по подпискам
      - BACKEND_BASE_URL=${BACKEND_BASE_URL}
      - BACKEND_TOKEN=${BACKEND_TOKEN}
      # Remnawave direct API (опционально)
      - REMNAWAVE_BASE_URL=${REMNAWAVE_BASE_URL}
      - REMNAWAVE_TOKEN=${REMNAWAVE_TOKEN}
      # Платежи YooMoney
      - YOOMONEY_TOKEN=${YOOMONEY_TOKEN}
      - YOOMONEY_WALLET=${YOOMONEY_WALLET}
      # Redis (обязательно для продакшена)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
    volumes:
      - ./data:/app/data
      - ./certs:/app/certs:ro
    # Порты не публикуем наружу - только через Caddy
    expose:
      - "${REMNAWAVE_API_PORT:-8081}"
      - "${WEB_API_PORT:-8082}"
    networks:
      - mtproxy-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8081/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: "5"
        compress: "true"

  # Redis для кэширования (обязательно для продакшена с тысячами пользователей)
  redis:
    image: redis:7-alpine
    container_name: mtproxy-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru --save 60 1000
    networks:
      - mtproxy-network
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

networks:
  mtproxy-network:
    driver: bridge

volumes:
  redis-data:
  caddy-data:
  caddy-config:
